---
- name: Set sshd service name
  set_fact:
    sshd_service_name: '{{ "ssh" if ansible_distribution == "Ubuntu" and ansible_distribution_version | int <= 14 else "sshd" }}'

- name: Allow/disallow SSH password login for root
  lineinfile:
    path: '{{ root_ssh_config_path }}'
    regexp: '^([#]?)(PermitRootLogin) .*$'
    line: '\2 {{ "yes" if root_remote_password_login else "without-password" }}'
    validate: 'sshd -t -f %s'
    backrefs: true
  register: linein_ssh_config

- name: Check if PermitRootLogin is already set
  lineinfile:
    state: absent
    path: '{{ root_ssh_config_path }}'
    regexp: '^([#]?)(PermitRootLogin) .*$'
  check_mode: true
  changed_when: false
  register: check

- name: Set PermitRootLogin if not set
  lineinfile:
    state: present
    path: '{{ root_ssh_config_path }}'
    line: 'PermitRootLogin {{ "yes" if root_remote_password_login else "without-password" }}'
    validate: 'sshd -t -f %s'
  when: check.found == 0
  register: permitroot

- name: Reload sshd
  service:
    name: '{{ sshd_service_name }}'
    state: reloaded
  when: (linein_ssh_config is changed) or (permitroot is changed)

- name: Update root password
  user:
    name: root
    password: '{{ root_password | default(omit) }}'
    password_lock: '{{ true if root_password is not defined else omit }}'

- name: Fix rights on root/.ssh
  file:
    state: directory
    path: /root/.ssh
    mode: 0700
    owner: root
    group: root
